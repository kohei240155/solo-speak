---
description: バグ修正のワークフロー（対話形式で調査→原因特定→修正）
---

# Fix Bug Command

バグ修正を対話形式で進め、ステアリングファイル群を生成するコマンドです。

## 出力ファイル

```
docs/steering/{YYYYMMDD}-fix-{bug-name}/
├── progress.md        # プロセス進捗（Step 2で作成）
├── investigation.md   # 調査結果（Phase 1-2で作成）
├── fix-plan.md        # 修正計画（Phase 2で作成）
└── tasklist.md        # タスクリスト（Phase 3で作成）
```

命名例: `docs/steering/20260113-fix-login-error/`

---

## 再開時の処理

コマンド実行時、まず `docs/steering/` 内に進行中のディレクトリ（`-fix-` を含む）があるか確認する。

**進行中のディレクトリがある場合**:
1. `progress.md` を読み込む
2. チェックボックスの状態から最初の未完了ステップを特定
3. ユーザーに現在の状況を報告:

```
進行中の作業が見つかりました。

📁 ディレクトリ: `docs/steering/{dir}/`
📊 現在のフェーズ: {Phase X}
⏳ 次のステップ: Step {N}

この作業を再開しますか？
```

4. 再開する場合、該当ステップから処理を続行
5. 新規で始める場合、Phase 1 の Step 1 から開始

**進行中のディレクトリがない場合**:
Phase 1 の Step 1 から開始。

### 複数の進行中ディレクトリがある場合

最も新しい日付のディレクトリを優先し、ユーザーに選択を求める:

```
複数の進行中作業が見つかりました。どちらを再開しますか？

1. 📁 `docs/steering/20260114-fix-login-error/` (Phase 2, Step 5)
2. 📁 `docs/steering/20260113-fix-api-timeout/` (Phase 1, Step 3)
3. 🆕 新規で始める
```

### チェックボックス状態の判定

`progress.md` のチェックリストを以下のルールでパース:

- `- [x]` → 完了
- `- [ ]` → 未完了
- 最初の未完了項目 = 次のステップ

**例**:
```markdown
- [x] Step 1: バグの症状ヒアリング完了
- [x] Step 2: ステアリングディレクトリ作成
- [ ] Step 3: 影響度と環境の確認  ← 次のステップ
```

---

## エージェントの呼び出し方法

本コマンドでは複数のエージェントを使用します。呼び出し方法は以下の通りです。

### Claude Code の Task ツールを使用

```
Task ツールを使用してエージェントを呼び出す:
- subagent_type: エージェント名（例: "file-finder"）
- prompt: エージェントへの指示（入力仕様に従う）
```

### 呼び出し例（Step 4: file-finder）

```
Task:
  subagent_type: "file-finder"
  prompt: |
    以下のバグに関連するファイルを検索してください。

    バグ名: ログインエラー
    症状: ログインボタンをクリックしても反応がない
    検索目的: バグ原因調査
    検索範囲: src/app/api/auth/, src/components/auth/, src/hooks/
```

**重要**: エージェントは独立コンテキストで実行されるため、必要な情報はすべてプロンプトに含めてください。

---

## Phase 1: バグ情報収集

### Step 1: バグの症状ヒアリング

ユーザーに以下を質問:

```
バグ修正を始めましょう。まず、バグの状況について教えてください:

1. **バグの症状**: どのような問題が発生していますか？
2. **再現手順**: どのような操作をすると発生しますか？
3. **期待動作**: 本来どのように動作すべきですか？
4. **実際の動作**: 実際にはどうなりますか？
```

### Step 2: ステアリングディレクトリの作成

ユーザーの回答をもとに:

1. 現在の日付を取得（`date +%Y%m%d`）
2. バグ名をkebab-caseに変換（日本語の場合は英語に翻訳）
3. `docs/steering/{YYYYMMDD}-fix-{bug-name}/` ディレクトリを作成
4. `progress.md` を作成（テンプレート: `.claude/skills/fix-bug/templates/progress-template.md`）
5. `investigation.md` を作成（テンプレート: `.claude/skills/fix-bug/templates/investigation-template.md`）
6. 「1. バグ概要」「2. 再現手順」「3. 期待動作 vs 実際の動作」セクションを埋める
7. `progress.md` の Step 1, Step 2 のチェックを更新

作成後、次のステップに進む旨を報告。

### Step 3: 影響度と環境の確認

```
次に、バグの影響度と発生環境を確認します。

**影響度**:
- Critical: サービス停止、データ損失
- High: 主要機能が使用不可
- Medium: 機能の一部が使用不可、回避策あり
- Low: 軽微な不具合

**発生環境**:
- ブラウザ / OS は何ですか？
- 本番環境 / 開発環境 / 両方で発生しますか？

それぞれ教えてください。
```

回答を得たら、`investigation.md` の「4. 発生環境」セクションを更新。

---

## Phase 2: 原因調査

### Step 4: コードベース調査（file-finder エージェント）

```
原因調査に入ります。関連する既存コードを調査します。
🔍 **file-finder エージェントを実行します（独立コンテキスト）**
```

→ 入力仕様: `.claude/agents/file-finder.md` を参照

調査結果を `investigation.md` の「5. 原因分析」セクションに反映。

### Step 5: 影響範囲分析（impact-analyzer エージェント）

```
原因が特定できました。次に、修正の影響範囲を分析します。
🔍 **impact-analyzer エージェントを実行します（独立コンテキスト）**
```

→ 入力仕様: `.claude/agents/impact-analyzer.md` を参照

分析結果を `investigation.md` の「6. 影響範囲」セクションに反映。
ステータスを `原因特定済み` に変更。

### Step 6: 修正計画の策定

```
原因と影響範囲が明確になりました。修正計画を策定しましょう。

**修正方針の検討**:
考慮事項:
- 最小限の変更で修正できるか
- 同様のバグを防ぐための対策が必要か
- ロールバックが必要になった場合の対応
```

対話を通じて以下を決定:

- 修正方針
- テスト計画
- ロールバック計画

決定後、`fix-plan.md` を作成（テンプレート: `.claude/skills/fix-bug/templates/fix-plan-template.md`）

---

## Phase 3: 実装計画

### Step 7: タスクリストの作成

```
タスクリストを作成します。

**バグ修正のタイプ**:
この修正はどのタイプに該当しますか？

A. **コードのみ**: ロジックの修正、条件の追加など
B. **UI修正**: 表示・スタイルの修正
C. **API修正**: エンドポイントの修正
D. **DB修正**: クエリ・スキーマの修正
E. **複合**: 上記の組み合わせ
```

#### タイプ選択ガイド

| ケース | 判断基準 | タイプ |
|--------|----------|--------|
| ボタンが動かない、表示崩れ | フロントエンドのみの問題 | A or B |
| APIがエラーを返す | バックエンドの問題 | C |
| データが正しく保存されない | DB/クエリの問題 | D |
| UI表示不具合だがAPIレスポンスが原因 | API + UI両方修正が必要 | E |
| 認証が通らない | 認証ロジック（API） | C |
| フォーム送信でエラー | 検証ロジックの場所による | A, C, or E |

#### 迷った場合のフローチャート

```
バグの原因はどこにある？
├─ フロントエンドのみ
│   ├─ ロジックの問題 → タイプ A
│   └─ スタイルの問題 → タイプ B
├─ バックエンドのみ
│   ├─ API処理の問題 → タイプ C
│   └─ DB/クエリの問題 → タイプ D
└─ 両方に関連
    └─ 複合 → タイプ E
```

修正タイプに関わらず、バグ修正専用テンプレートで `tasklist.md` を作成:
- `.claude/skills/fix-bug/templates/tasklist.md`

### Step 8: 最終確認と実装開始

すべてのファイルが揃ったら:

```
ステアリングファイルが完成しました！

📁 **ステアリングディレクトリ**: `docs/steering/{YYYYMMDD}-fix-{bug-name}/`

| ファイル | 内容 |
|----------|------|
| investigation.md | 調査結果（症状、再現手順、原因） |
| fix-plan.md | 修正計画（方針、テスト計画） |
| tasklist.md | タスクリスト |

---

## サマリー

- **バグ名**: {バグ名}
- **影響度**: {Critical/High/Medium/Low}
- **変更ファイル数**: {概算}

### 推奨エージェントフロー
file-finder → impact-analyzer → [修正] → test-runner → code-reviewer

---

修正を開始しますか？
```

---

## Phase 4: 実装・検証

### Step 9: 実装

`tasklist.md` に従って修正を進める。各タスク完了時に `progress.md` のチェックを更新。

### Step 10: ビルド確認（build-executor エージェント）

🔧 **build-executor エージェントを実行**（独立コンテキスト）
→ 入力仕様: `.claude/agents/build-executor.md` を参照

エラーがあれば修正し、再度ビルドを実行。

### Step 11: テスト・Lint（test-runner エージェント）

🧪 **test-runner エージェントを実行**（独立コンテキスト）
→ 入力仕様: `.claude/agents/test-runner.md` を参照

エラー・警告を解消。

### Step 12: コードレビュー（code-reviewer エージェント）

🔍 **code-reviewer エージェントを実行**（独立コンテキスト）
→ 入力仕様: `.claude/agents/code-reviewer.md` を参照

Critical Issues を解消。

### Step 13: セキュリティチェック（security-checker エージェント）

🔒 **security-checker エージェントを実行**（独立コンテキスト）
→ 入力仕様: `.claude/agents/security-checker.md` を参照

脆弱性があれば修正。

### Step 14: ドキュメント整合性（review-docs エージェント）

📝 **review-docs エージェントを実行**（独立コンテキスト）
→ 入力仕様: `.claude/agents/review-docs.md` を参照

関連ドキュメントを更新（必要な場合）。

---

## 注意事項

- ディレクトリは Step 2 で即座に作成し、以降のファイルは随時追加・更新する
- 各ステップでユーザーの回答を待ってから次に進む
- 最小限の修正で問題を解決することを優先する
- 技術的な判断が必要な場合は、CLAUDE.md を参照する
- 対話が中断されても、途中まで入力した内容はファイルに保存されている
- 完了後、`mv docs/steering/{dir} docs/steering/archive/` でアーカイブ

---

## エラーハンドリング

各ステップで問題が発生した場合の対応フロー:

### Step 10 (ビルド) で失敗した場合

1. エラーメッセージを分析
2. `build-executor` エージェントの提案に従って修正
3. 修正後、再度 Step 10 を実行
4. 3回失敗した場合、ユーザーに状況を報告し対応を相談

### Step 11 (テスト/Lint) で失敗した場合

1. 失敗内容を分類（Lint エラー / 型エラー / テスト失敗）
2. 優先順位: 型エラー → Lint エラー → テスト失敗
3. 各エラーを修正し、再度 Step 11 を実行
4. テスト失敗が修正ロジックに起因する場合、Step 9 に戻る

### Step 12-14 で問題が見つかった場合

1. 問題の重大度を判定（Critical / Warning / Info）
2. Critical: 即座に修正し、Step 10 から再検証
3. Warning: ユーザーに報告し、修正するか確認
4. Info: 記録のみ、次のステップへ進む

### フローチャート

```
[Step 10: ビルド]
    ↓ 失敗
    → 修正 → 再実行（最大3回）
    → 3回失敗 → ユーザーに相談
    ↓ 成功
[Step 11: テスト/Lint]
    ↓ 失敗
    → 修正 → 再実行
    → ロジック問題 → Step 9 に戻る
    ↓ 成功
[Step 12-14: レビュー系]
    ↓ Critical
    → 修正 → Step 10 に戻る
    ↓ Warning/Info
    → 記録 → 次へ
```
