# タイムゾーン対応リセット - 変更要求

**ステータス**: 要求確定
**作成日**: 2026-01-16
**最終更新日**: 2026-01-16

---

## 1. 変更概要

### 対象機能

- フレーズ生成回数のリセット機能
- スピーチ可能回数のリセット機能
- ストリーク（連続学習）機能

### 変更の種類

- [x] 動作変更: 既存機能の動作を変更

---

## 2. 変更理由

### 背景

現在、フレーズ生成とスピーチ可能回数のリセットはUTC時間の午前0時を基準にしている。これにより、ユーザーの現地時間とリセットタイミングが一致せず、ユーザー体験に影響を与えている。

### 現状の問題点

- 日本（UTC+9）のユーザーは午前9時にリセットされる
- アメリカ西海岸（UTC-8）のユーザーは前日の午後4時にリセットされる
- ユーザーにとって直感的でないタイミングでリセットが発生する

### 期待する効果

- 全ユーザーが自分の現地時間の午前0時にリセットを体験できる
- より自然で直感的なユーザー体験を提供
- ストリーク機能も現地時間ベースで正確に計算される

---

## 3. 変更内容

### 現在の動作

- UTC時間の午前0時にフレーズ生成回数・スピーチ可能回数がリセット
- ストリーク計算もUTCベースで行われている（要確認）

### 変更後の動作

- ユーザーのローカルタイムゾーンの午前0時にリセット
- タイムゾーンはブラウザから自動検出（`Intl.DateTimeFormat().resolvedOptions().timeZone`）
- 既存ユーザーは初回アクセス時にタイムゾーンを自動検出して保存
- ストリーク機能も同じタイムゾーンベースで計算
- **不正防止**: 前回リセットから20時間以上経過していないとリセットしない

### タイムゾーン更新ポリシー

- **初回設定**: ブラウザから自動検出して保存
- **自動更新**: 初回設定後は自動更新しない（旅行時も元のTZを維持）
- **手動変更**: 設定画面からユーザーが変更可能（引っ越し対応）
- **既存ユーザー**: DBデフォルトはUTC、初回アクセス時にブラウザから正しいTZを取得・設定

### 変更しない部分

- リセットされる回数の上限値
- ストリークの計算ロジック（日数のカウント方法）

---

## 4. 後方互換性

### 破壊的変更の有無

- [x] 破壊的変更あり（以下に詳細を記載）

### 破壊的変更の詳細

- リセットタイミングがUTC午前0時からローカル午前0時に変更される
- タイムゾーンによっては、変更適用後のリセットが早まる/遅れるケースがある
- 例: 日本（UTC+9）では、これまで午前9時だったリセットが午前0時に早まる

### 移行対応

- [x] 移行対応必要:
  - DBにtimezoneカラムを追加（デフォルト: "UTC"）
  - 既存ユーザーは初回アクセス時にブラウザからタイムゾーンを自動検出して上書き
  - 変更適用日はストリーク判定を緩和（1日の猶予を設ける）
  - 設定画面にタイムゾーン変更UIを追加

---

## 5. 成功指標

| 指標 | 目標値 | 測定方法 |
|------|--------|----------|
| タイムゾーン設定率 | 100% | timezone カラムが設定されているユーザーの割合 |
| リセットタイミング | ローカル午前0時 | 各ユーザーのタイムゾーンに基づくリセット実行 |
| ストリーク継続率 | 変更前後で維持 | 変更適用前後のアクティブストリーク数比較 |

---

## 6. 制約条件

### 技術的制約

- ブラウザのタイムゾーン検出に依存（JavaScript必須）
- サーバーサイドでの日付計算にタイムゾーン情報が必要

### ビジネス制約

- 既存ユーザーのストリークデータを破壊しない

### 前提条件

- ユーザーのブラウザでJavaScriptが有効
- Intl APIが利用可能なブラウザ

---

## 参考情報

- 対象機能の既存実装（影響分析で特定）
